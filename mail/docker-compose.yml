version: '3.8'

x-traefik-enable-labels: &traefik-labels
  traefik.enable: "true"
  traefik.swarm.network: "traefik"
  traefik.constraint-label: "traefik"

x-api-deploy: &api-deployment
  mode: replicated
  update_config:
    parallelism: 1
    delay: 5s
    order: start-first
    failure_action: rollback
  rollback_config:
    order: start-first
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3
    window: 120s


services:
  ntfy:
    image: binwiederhier/ntfy:v2.15
    command:
      - serve
    environment:
      - TZ=Europe/Berlin
    user: 1000:1000
    volumes:
      - ntfy:/etc/ntfy
    healthcheck: # optional: remember to adapt the host:port to your environment
        test: ["CMD-SHELL", "wget -q --tries=1 http://localhost:80/v1/health -O - | grep -Eo '\"healthy\"\\s*:\\s*true' || exit 1"]
        interval: 60s
        timeout: 10s
        retries: 3
        start_period: 40s
    init: true 
    networks:
      - local
      - traefik
    configs:
      - source: ntfy_config
        target: /etc/ntfy/server.yml
        uid: '1000'
        gid: '1000'
        mode: 0400
    deploy:
      replicas: 1
      <<: *api-deployment
      labels:
        <<: *traefik-labels
        traefik.http.routers.ntfy.rule: "Host(`ntfy.szabolcsi.dev`)"
        traefik.http.routers.ntfy.entrypoints: "https"
        traefik.http.routers.ntfy.tls: "true"
        traefik.http.routers.ntfy.tls.certresolver: "letsencrypt"
        traefik.http.services.ntfy.loadbalancer.server.port: "80"

  mail_notification:
    image: gitea.szabolcsi.dev/kriszcode/imap_notification:0.1.0
    environment:
      - TZ=Europe/Berlin
      - NTFY_URL=http://ntfy/
    secrets:
      - source: mail_config
        target: /app/config.json
        uid: '1000'
        gid: '1000'
        mode: 0400
    networks:
      - local
    deploy:
      replicas: 1
      <<: *api-deployment

  proxy:
    image: haproxy:3.1.7-alpine
    hostname: mail-proxy
    environment:
      - TZ=Europe/Berlin
    networks:
      - local
      - public
    configs:
      - source: haproxy
        target: /usr/local/etc/haproxy/haproxy.cfg
    deploy:
      replicas: 1
      <<: *api-deployment


networks:
  local:
    name: mail
    driver: overlay
    internal: true
    ipam:
      config:
        - subnet: 172.30.18.0/24
  traefik:
    external: true
  public:
    name: base-public
    external: true


volumes:
  ntfy:
    name: ntfy_data
    driver: local
    driver_opts:
      type: nfs
      device: ":/nfs_share/mail/ntfy"
      o: "addr=10.0.0.3,rw,soft,nfsvers=4"

secrets:
  mail_config:
    name: "${MAIL_NOTIFICATION_SECRET_NAME}"
    external: true

configs:
  haproxy:
    name: "${HAPROXY_CONFIG_NAME}"
    external: true
  ntfy_config:
    name: "${NTFY_CONFIG_NAME}"
    external: true
  
